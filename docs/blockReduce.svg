<svg width="1200" height="800" xmlns="http://www.w3.org/2000/svg">
  <!-- Background -->
  <rect width="1200" height="800" fill="#ffffff" stroke="#ccc" stroke-width="1"/>
  
  <!-- Title -->
  <text x="600" y="25" text-anchor="middle" font-family="Arial" font-size="20" font-weight="bold" fill="#2c3e50">
    blockReduce() - Multi-Warp Block Reduction (256 threads = 8 warps)
  </text>
  
  <!-- Step 0: Initial Layout -->
  <text x="50" y="60" font-family="Arial" font-size="14" font-weight="bold" fill="#2c3e50">
    Step 0: Block Layout (256 threads organized as 8 warps)
  </text>
  
  <!-- Initial block structure -->
  <g id="initial-block">
    <!-- Warp 0 -->
    <rect x="50" y="75" width="130" height="35" fill="#3498db" stroke="#2c3e50"/>
    <text x="115" y="95" text-anchor="middle" font-size="11" fill="white" font-weight="bold">
      Warp 0 (T0-31)
    </text>
    <text x="115" y="107" text-anchor="middle" font-size="9" fill="white">
      wid=0, lane=0-31
    </text>
    
    <!-- Warp 1 -->
    <rect x="190" y="75" width="130" height="35" fill="#3498db" stroke="#2c3e50"/>
    <text x="255" y="95" text-anchor="middle" font-size="11" fill="white" font-weight="bold">
      Warp 1 (T32-63)
    </text>
    <text x="255" y="107" text-anchor="middle" font-size="9" fill="white">
      wid=1, lane=0-31
    </text>
    
    <!-- Warp 2 -->
    <rect x="330" y="75" width="130" height="35" fill="#3498db" stroke="#2c3e50"/>
    <text x="395" y="95" text-anchor="middle" font-size="11" fill="white" font-weight="bold">
      Warp 2 (T64-95)
    </text>
    <text x="395" y="107" text-anchor="middle" font-size="9" fill="white">
      wid=2, lane=0-31
    </text>
    
    <!-- Warp 3 -->
    <rect x="470" y="75" width="130" height="35" fill="#3498db" stroke="#2c3e50"/>
    <text x="535" y="95" text-anchor="middle" font-size="11" fill="white" font-weight="bold">
      Warp 3 (T96-127)
    </text>
    <text x="535" y="107" text-anchor="middle" font-size="9" fill="white">
      wid=3, lane=0-31
    </text>
    
    <!-- Second row -->
    <rect x="50" y="120" width="130" height="35" fill="#3498db" stroke="#2c3e50"/>
    <text x="115" y="140" text-anchor="middle" font-size="11" fill="white" font-weight="bold">
      Warp 4 (T128-159)
    </text>
    <text x="115" y="152" text-anchor="middle" font-size="9" fill="white">
      wid=4, lane=0-31
    </text>
    
    <rect x="190" y="120" width="130" height="35" fill="#3498db" stroke="#2c3e50"/>
    <text x="255" y="140" text-anchor="middle" font-size="11" fill="white" font-weight="bold">
      Warp 5 (T160-191)
    </text>
    <text x="255" y="152" text-anchor="middle" font-size="9" fill="white">
      wid=5, lane=0-31
    </text>
    
    <rect x="330" y="120" width="130" height="35" fill="#3498db" stroke="#2c3e50"/>
    <text x="395" y="140" text-anchor="middle" font-size="11" fill="white" font-weight="bold">
      Warp 6 (T192-223)
    </text>
    <text x="395" y="152" text-anchor="middle" font-size="9" fill="white">
      wid=6, lane=0-31
    </text>
    
    <rect x="470" y="120" width="130" height="35" fill="#3498db" stroke="#2c3e50"/>
    <text x="535" y="140" text-anchor="middle" font-size="11" fill="white" font-weight="bold">
      Warp 7 (T224-255)
    </text>
    <text x="535" y="152" text-anchor="middle" font-size="9" fill="white">
      wid=7, lane=0-31
    </text>
  </g>
  
  <!-- Key calculations -->
  <rect x="650" y="75" width="500" height="80" fill="#ecf0f1" stroke="#2c3e50"/>
  <text x="900" y="95" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold" fill="#2c3e50">
    Key Variables for Each Thread
  </text>
  <text x="670" y="115" font-family="monospace" font-size="11" fill="#e74c3c">
    lane = threadIdx.x % 32    // Position within warp (0-31)
  </text>
  <text x="670" y="130" font-family="monospace" font-size="11" fill="#e74c3c">
    wid = threadIdx.x / 32     // Warp ID (0-7 for 8 warps)
  </text>
  <text x="670" y="145" font-family="monospace" font-size="11" fill="#7f8c8d">
    Example: T65 → lane=1, wid=2
  </text>
  
  <!-- Step 1: Warp-level reduction -->
  <text x="50" y="185" font-family="Arial" font-size="14" font-weight="bold" fill="#2c3e50">
    Step 1: val = warpReduce(val) - Each warp reduces internally
  </text>
  
  <!-- After warp reductions -->
  <g id="after-warp-reduce">
    <!-- Each warp now has one result in thread 0 of that warp -->
    <rect x="50" y="200" width="130" height="35" fill="#e74c3c" stroke="#2c3e50"/>
    <text x="115" y="220" text-anchor="middle" font-size="10" fill="white" font-weight="bold">
      T0: sum₀ (active)
    </text>
    <text x="115" y="232" text-anchor="middle" font-size="8" fill="white">
      T1-31: partial sums
    </text>
    
    <rect x="190" y="200" width="130" height="35" fill="#e74c3c" stroke="#2c3e50"/>
    <text x="255" y="220" text-anchor="middle" font-size="10" fill="white" font-weight="bold">
      T32: sum₁ (active)
    </text>
    <text x="255" y="232" text-anchor="middle" font-size="8" fill="white">
      T33-63: partial sums
    </text>
    
    <rect x="330" y="200" width="130" height="35" fill="#e74c3c" stroke="#2c3e50"/>
    <text x="395" y="220" text-anchor="middle" font-size="10" fill="white" font-weight="bold">
      T64: sum₂ (active)
    </text>
    <text x="395" y="232" text-anchor="middle" font-size="8" fill="white">
      T65-95: partial sums
    </text>
    
    <rect x="470" y="200" width="130" height="35" fill="#e74c3c" stroke="#2c3e50"/>
    <text x="535" y="220" text-anchor="middle" font-size="10" fill="white" font-weight="bold">
      T96: sum₃ (active)
    </text>
    <text x="535" y="232" text-anchor="middle" font-size="8" fill="white">
      T97-127: partial sums
    </text>
    
    <rect x="50" y="245" width="130" height="35" fill="#e74c3c" stroke="#2c3e50"/>
    <text x="115" y="265" text-anchor="middle" font-size="10" fill="white" font-weight="bold">
      T128: sum₄ (active)
    </text>
    
    <rect x="190" y="245" width="130" height="35" fill="#e74c3c" stroke="#2c3e50"/>
    <text x="255" y="265" text-anchor="middle" font-size="10" fill="white" font-weight="bold">
      T160: sum₅ (active)
    </text>
    
    <rect x="330" y="245" width="130" height="35" fill="#e74c3c" stroke="#2c3e50"/>
    <text x="395" y="265" text-anchor="middle" font-size="10" fill="white" font-weight="bold">
      T192: sum₆ (active)
    </text>
    
    <rect x="470" y="245" width="130" height="35" fill="#e74c3c" stroke="#2c3e50"/>
    <text x="535" y="265" text-anchor="middle" font-size="10" fill="white" font-weight="bold">
      T224: sum₇ (active)
    </text>
  </g>
  
  <!-- Step 2: Write to shared memory -->
  <text x="50" y="305" font-family="Arial" font-size="14" font-weight="bold" fill="#2c3e50">
    Step 2: if (lane == 0) shared[wid] = val; - Warp leaders store in shared memory
  </text>
  
  <!-- Shared memory array -->
  <rect x="100" y="320" width="500" height="50" fill="#f39c12" stroke="#2c3e50" stroke-width="2"/>
  <text x="350" y="340" text-anchor="middle" font-size="12" fill="white" font-weight="bold">
    shared[32] array (only first 8 slots used)
  </text>
  <text x="350" y="355" text-anchor="middle" font-size="10" fill="white">
    shared[0]=sum₀, shared[1]=sum₁, shared[2]=sum₂, ..., shared[7]=sum₇
  </text>
  
  <!-- Arrows from warp leaders to shared memory -->
  <defs>
    <marker id="arrow-orange" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#f39c12"/>
    </marker>
  </defs>
  
  <path d="M 115 235 L 150 320" stroke="#f39c12" stroke-width="2" marker-end="url(#arrow-orange)"/>
  <path d="M 255 235 L 250 320" stroke="#f39c12" stroke-width="2" marker-end="url(#arrow-orange)"/>
  <path d="M 395 235 L 350 320" stroke="#f39c12" stroke-width="2" marker-end="url(#arrow-orange)"/>
  <path d="M 535 235 L 450 320" stroke="#f39c12" stroke-width="2" marker-end="url(#arrow-orange)"/>
  <path d="M 115 280 L 200 320" stroke="#f39c12" stroke-width="2" marker-end="url(#arrow-orange)"/>
  <path d="M 255 280 L 300 320" stroke="#f39c12" stroke-width="2" marker-end="url(#arrow-orange)"/>
  <path d="M 395 280 L 400 320" stroke="#f39c12" stroke-width="2" marker-end="url(#arrow-orange)"/>
  <path d="M 535 280 L 500 320" stroke="#f39c12" stroke-width="2" marker-end="url(#arrow-orange)"/>
  
  <!-- Synchronization barrier -->
  <rect x="650" y="320" width="300" height="50" fill="#e74c3c" stroke="#2c3e50"/>
  <text x="800" y="340" text-anchor="middle" font-size="14" fill="white" font-weight="bold">
    __syncthreads()
  </text>
  <text x="800" y="355" text-anchor="middle" font-size="11" fill="white">
    All threads wait for shared memory writes
  </text>
  
  <!-- Step 3: Final reduction -->
  <text x="50" y="395" font-family="Arial" font-size="14" font-weight="bold" fill="#2c3e50">
    Step 3: Only first warp reduces the 8 partial results
  </text>
  
  <!-- Code explanation -->
  <rect x="70" y="410" width="600" height="60" fill="#2c3e50" stroke="#34495e"/>
  <text x="90" y="430" font-family="monospace" font-size="11" fill="#3498db">
    val = (threadIdx.x &lt; blockDim.x / WARP_SIZE) ? shared[lane] : 0;
  </text>
  <text x="90" y="445" font-family="monospace" font-size="11" fill="#e74c3c">
    if (wid == 0) val = warpReduce(val);
  </text>
  <text x="90" y="460" font-family="monospace" font-size="10" fill="#f39c12">
    // Only threads 0-7 get shared values, others get 0
  </text>
  
  <!-- Final warp reduction visualization -->
  <text x="50" y="495" font-family="Arial" font-size="13" font-weight="bold" fill="#2c3e50">
    Final warp reduction (only first 8 threads of warp 0):
  </text>
  
  <!-- Active threads in final reduction -->
  <rect x="100" y="510" width="40" height="30" fill="#27ae60" stroke="#2c3e50"/>
  <text x="120" y="525" text-anchor="middle" font-size="9" fill="white">T0</text>
  <text x="120" y="535" text-anchor="middle" font-size="7" fill="white">sum₀</text>
  
  <rect x="150" y="510" width="40" height="30" fill="#27ae60" stroke="#2c3e50"/>
  <text x="170" y="525" text-anchor="middle" font-size="9" fill="white">T1</text>
  <text x="170" y="535" text-anchor="middle" font-size="7" fill="white">sum₁</text>
  
  <rect x="200" y="510" width="40" height="30" fill="#27ae60" stroke="#2c3e50"/>
  <text x="220" y="525" text-anchor="middle" font-size="9" fill="white">T2</text>
  <text x="220" y="535" text-anchor="middle" font-size="7" fill="white">sum₂</text>
  
  <rect x="250" y="510" width="40" height="30" fill="#27ae60" stroke="#2c3e50"/>
  <text x="270" y="525" text-anchor="middle" font-size="9" fill="white">T3</text>
  <text x="270" y="535" text-anchor="middle" font-size="7" fill="white">sum₃</text>
  
  <rect x="300" y="510" width="40" height="30" fill="#27ae60" stroke="#2c3e50"/>
  <text x="320" y="525" text-anchor="middle" font-size="9" fill="white">T4</text>
  <text x="320" y="535" text-anchor="middle" font-size="7" fill="white">sum₄</text>
  
  <rect x="350" y="510" width="40" height="30" fill="#27ae60" stroke="#2c3e50"/>
  <text x="370" y="525" text-anchor="middle" font-size="9" fill="white">T5</text>
  <text x="370" y="535" text-anchor="middle" font-size="7" fill="white">sum₅</text>
  
  <rect x="400" y="510" width="40" height="30" fill="#27ae60" stroke="#2c3e50"/>
  <text x="420" y="525" text-anchor="middle" font-size="9" fill="white">T6</text>
  <text x="420" y="535" text-anchor="middle" font-size="7" fill="white">sum₆</text>
  
  <rect x="450" y="510" width="40" height="30" fill="#27ae60" stroke="#2c3e50"/>
  <text x="470" y="525" text-anchor="middle" font-size="9" fill="white">T7</text>
  <text x="470" y="535" text-anchor="middle" font-size="7" fill="white">sum₇</text>
  
  <!-- Inactive threads -->
  <rect x="500" y="510" width="80" height="30" fill="#bdc3c7" stroke="#2c3e50"/>
  <text x="540" y="530" text-anchor="middle" font-size="9" fill="black">T8-31: val=0</text>
  
  <!-- Final result -->
  <text x="50" y="565" font-family="Arial" font-size="13" font-weight="bold" fill="#2c3e50">
    After warpReduce() on these 8 values:
  </text>
  
  <rect x="200" y="575" width="120" height="40" fill="#c0392b" stroke="#2c3e50" stroke-width="3"/>
  <text x="260" y="595" text-anchor="middle" font-size="12" fill="white" font-weight="bold">
    Thread 0 Final Result
  </text>
  <text x="260" y="608" text-anchor="middle" font-size="10" fill="white">
    Sum of all 256 values
  </text>
  
  <!-- Summary box -->
  <rect x="50" y="640" width="1100" height="120" fill="#f8f9fa" stroke="#2c3e50" stroke-width="2"/>
  <text x="600" y="665" text-anchor="middle" font-family="Arial" font-size="16" font-weight="bold" fill="#2c3e50">
    Summary: Three-Phase Reduction Process
  </text>
  
  <text x="80" y="690" font-family="Arial" font-size="13" fill="#e74c3c" font-weight="bold">
    Phase 1: Intra-warp reduction
  </text>
  <text x="100" y="705" font-family="Arial" font-size="11" fill="#7f8c8d">
    • Each of 8 warps reduces its 32 values to 1 using warpReduce()
  </text>
  
  <text x="400" y="690" font-family="Arial" font-size="13" fill="#f39c12" font-weight="bold">
    Phase 2: Inter-warp communication
  </text>
  <text x="420" y="705" font-family="Arial" font-size="11" fill="#7f8c8d">
    • Warp leaders store partial results in shared memory
  </text>
  
  <text x="720" y="690" font-family="Arial" font-size="13" fill="#27ae60" font-weight="bold">
    Phase 3: Final reduction
  </text>
  <text x="740" y="705" font-family="Arial" font-size="11" fill="#7f8c8d">
    • First warp reduces 8 partial sums to 1 final result
  </text>
  
  <text x="80" y="725" font-family="Arial" font-size="12" fill="#2c3e50" font-weight="bold">
    Complexity: O(log₂ 256) = 8 steps total
  </text>
  <text x="400" y="725" font-family="Arial" font-size="12" fill="#2c3e50">
    • 5 steps for warp reductions + 3 steps for final reduction
  </text>
  <text x="720" y="725" font-family="Arial" font-size="12" fill="#2c3e50">
    • Uses both registers and shared memory efficiently
  </text>
  
  <text x="80" y="745" font-family="Arial" font-size="11" fill="#e67e22" font-style="italic">
    Critical: __syncthreads() ensures all warp results are written before final reduction begins
  </text>
</svg>
