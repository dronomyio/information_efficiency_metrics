<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertica UDx Trigger Flow Visualization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        
        .flow-diagram {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            position: relative;
        }
        
        .process-box {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .process-box:hover {
            transform: translateX(10px);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }
        
        .process-title {
            font-size: 1.3em;
            color: #00ffff;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .code-block {
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
        }
        
        .sql { color: #ff79c6; }
        .cpp { color: #50fa7b; }
        .comment { color: #6272a4; }
        .keyword { color: #ff79c6; }
        .function { color: #8be9fd; }
        .string { color: #f1fa8c; }
        .number { color: #bd93f9; }
        
        .arrow {
            text-align: center;
            font-size: 2em;
            color: #00ffff;
            margin: 15px 0;
            position: relative;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translateY(0); opacity: 0.6; }
            50% { transform: translateY(10px); opacity: 1; }
        }
        
        .latency-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #00ff00, #00ff88);
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            animation: glow 2s infinite;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 255, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.8); }
        }
        
        .memory-diagram {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .memory-block {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .memory-block.active {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffff;
        }
        
        .timeline {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .timeline-item {
            text-align: center;
            flex: 1;
            position: relative;
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            right: -50%;
            top: 25px;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #00ffff, transparent);
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
        
        .time-value {
            font-size: 1.5em;
            color: #00ff00;
            font-weight: bold;
        }
        
        .time-label {
            font-size: 0.8em;
            color: #aaa;
            margin-top: 5px;
        }
        
        .highlight {
            background: rgba(255, 255, 0, 0.2);
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .flow-animation {
            position: absolute;
            width: 4px;
            height: 20px;
            background: #00ffff;
            border-radius: 2px;
            animation: flow 2s infinite;
        }
        
        @keyframes flow {
            0% { top: 0; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        
        button {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: #000;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1> Vertica UDx Trigger → Microstructure Code Execution Flow</h1>
        
        <div class="flow-diagram">
            <!-- Step 1: Data Arrival -->
            <div class="process-box">
                <span class="latency-badge">T + 0ns</span>
                <div class="process-title"> Step 1: Market Data Arrives</div>
                <div class="code-block">
                    <span class="comment">// WebSocket data from Polygon.io</span><br>
                    {<br>
                    &nbsp;&nbsp;<span class="string">"symbol"</span>: <span class="string">"AAPL"</span>,<br>
                    &nbsp;&nbsp;<span class="string">"price"</span>: <span class="number">150.25</span>,<br>
                    &nbsp;&nbsp;<span class="string">"volume"</span>: <span class="number">1000</span>,<br>
                    &nbsp;&nbsp;<span class="string">"timestamp"</span>: <span class="number">1673827200123456789</span> <span class="comment">// nanoseconds</span><br>
                    }
                </div>
            </div>
            
            <div class="arrow">⬇</div>
            
            <!-- Step 2: Vertica Insert -->
            <div class="process-box">
                <span class="latency-badge">T + 30ns</span>
                <div class="process-title"> Step 2: Insert into Vertica Table</div>
                <div class="code-block">
                    <span class="sql">INSERT INTO</span> trades (symbol, price, volume, timestamp)<br>
                    <span class="sql">VALUES</span> (<span class="string">'AAPL'</span>, <span class="number">150.25</span>, <span class="number">1000</span>, <span class="number">1673827200123456789</span>);
                </div>
            </div>
            
            <div class="arrow">⬇</div>
            
            <!-- Step 3: Trigger Fires -->
            <div class="process-box">
                <span class="latency-badge">T + 50ns</span>
                <div class="process-title"> Step 3: UDx Trigger Fires (In-Process)</div>
                <div class="code-block">
                    <span class="sql">CREATE TRIGGER</span> on_trade_insert<br>
                    <span class="sql">AFTER INSERT ON</span> trades<br>
                    <span class="sql">FOR EACH ROW</span><br>
                    <span class="sql">EXECUTE PROCEDURE</span> <span class="function">compute_microstructure</span>()<br>
                    <span class="sql">AS EXTERNAL NAME</span> <span class="string">'microstructure.so!ProcessTrade'</span>;<br><br>
                    
                    <span class="comment">-- Trigger calls C++ function directly in Vertica's memory space</span>
                </div>
            </div>
            
            <div class="arrow">⬇</div>
            
            <!-- Step 4: Memory Handoff -->
            <div class="process-box">
                <span class="latency-badge">T + 70ns</span>
                <div class="process-title"> Step 4: Direct Memory Access (Zero Copy)</div>
                <div class="memory-diagram">
                    <div class="memory-block active">
                        <strong>Vertica Process</strong><br>
                        Memory: 0x7FFF0000<br>
                        <small>Column Store Buffer</small>
                    </div>
                    <div class="memory-block active">
                        <strong>Shared Memory</strong><br>
                        Memory: 0x7FFF1000<br>
                        <small>Same Address Space</small>
                    </div>
                    <div class="memory-block active">
                        <strong>UDx Function</strong><br>
                        Memory: 0x7FFF2000<br>
                        <small>microstructure.so</small>
                    </div>
                </div>
                <div class="code-block">
                    <span class="cpp">// C++ UDx Function (runs in Vertica's process)</span><br>
                    <span class="keyword">class</span> <span class="function">MicrostructureUDx</span> : <span class="keyword">public</span> ScalarFunction {<br>
                    &nbsp;&nbsp;<span class="keyword">virtual void</span> <span class="function">processBlock</span>(ServerInterface &srvInterface,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlockReader &args,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlockWriter &res) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Direct pointer to Vertica's columnar data - NO COPY!</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const float*</span> prices = args.<span class="function">getFloatPtr</span>(<span class="number">0</span>);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const int64_t*</span> timestamps = args.<span class="function">getIntPtr</span>(<span class="number">1</span>);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Function pointer jump - same process, no context switch</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="function">triggerMicrostructureCompute</span>(prices, timestamps);<br>
                    &nbsp;&nbsp;}<br>
                    };
                </div>
            </div>
            
            <div class="arrow">⬇</div>
            
            <!-- Step 5: Microstructure Execution -->
            <div class="process-box">
                <span class="latency-badge">T + 100ns</span>
                <div class="process-title"> Step 5: Microstructure Code Execution</div>
                <div class="code-block">
                    <span class="cpp">// Your CUDA/SIMD microstructure code</span><br>
                    <span class="keyword">void</span> <span class="function">triggerMicrostructureCompute</span>(<span class="keyword">const float*</span> prices,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const int64_t*</span> timestamps) {<br>
                    &nbsp;&nbsp;<br>
                    &nbsp;&nbsp;<span class="comment">// Branch to appropriate module based on conditions</span><br>
                    &nbsp;&nbsp;<span class="keyword">if</span> (needsGPU) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Launch CUDA kernel - already warmed up</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;cuda_variance_ratio&lt;&lt;&lt;blocks, threads&gt;&gt;&gt;(prices);<br>
                    &nbsp;&nbsp;} <span class="keyword">else</span> {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// SIMD AVX-512 computation</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;__m512d price_vec = _mm512_load_pd(prices);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;simd_compute_autocorrelation(price_vec);<br>
                    &nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;<br>
                    &nbsp;&nbsp;<span class="comment">// Write results back to same memory space</span><br>
                    &nbsp;&nbsp;*result_ptr = computed_metric; <span class="comment">// Direct write, no serialization</span><br>
                    }
                </div>
            </div>
            
            <div class="arrow">⬇</div>
            
            <!-- Step 6: Result Available -->
            <div class="process-box">
                <span class="latency-badge">T + 150ns</span>
                <div class="process-title"> Step 6: Results Written Back</div>
                <div class="code-block">
                    <span class="sql">-- Results immediately available in Vertica</span><br>
                    <span class="sql">SELECT</span> symbol, price, variance_ratio, autocorrelation<br>
                    <span class="sql">FROM</span> microstructure_metrics<br>
                    <span class="sql">WHERE</span> timestamp >= NOW() - INTERVAL <span class="string">'1 second'</span>;
                </div>
            </div>
            
            <!-- Timeline -->
            <div class="timeline">
                <div class="timeline-item">
                    <div class="time-value">0ns</div>
                    <div class="time-label">Data Arrival</div>
                </div>
                <div class="timeline-item">
                    <div class="time-value">30ns</div>
                    <div class="time-label">INSERT</div>
                </div>
                <div class="timeline-item">
                    <div class="time-value">50ns</div>
                    <div class="time-label">Trigger</div>
                </div>
                <div class="timeline-item">
                    <div class="time-value">70ns</div>
                    <div class="time-label">Memory Access</div>
                </div>
                <div class="timeline-item">
                    <div class="time-value">100ns</div>
                    <div class="time-label">Compute</div>
                </div>
                <div class="timeline-item">
                    <div class="time-value">150ns</div>
                    <div class="time-label">Complete</div>
                </div>
            </div>
            
            <!-- Key Points -->
            <div class="process-box" style="background: rgba(255, 255, 0, 0.1); border-color: #ffff00;">
                <div class="process-title"> Why It's So Fast (100ns)</div>
                <ul style="line-height: 1.8; padding-left: 20px;">
                    <li><span class="highlight">Same Process Space</span>: UDx runs inside Vertica's process - no IPC overhead</li>
                    <li><span class="highlight">Zero Copy</span>: Direct pointer access to columnar data - no serialization</li>
                    <li><span class="highlight">No Context Switch</span>: Function pointer jump within same thread</li>
                    <li><span class="highlight">Pre-compiled</span>: .so library already loaded in memory</li>
                    <li><span class="highlight">Warmed GPU</span>: CUDA kernels kept persistent, no initialization</li>
                    <li><span class="highlight">Shared Memory</span>: Same virtual address space as Vertica</li>
                </ul>
            </div>
            
            <!-- Comparison -->
            <div class="process-box" style="background: rgba(255, 0, 0, 0.1); border-color: #ff6666;">
                <div class="process-title"> Comparison with External Calls</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div>
                        <strong style="color: #00ff00;"> UDx In-Process (100ns)</strong>
                        <ul style="margin-top: 10px; font-size: 0.9em;">
                            <li>Direct function call</li>
                            <li>Same memory space</li>
                            <li>No serialization</li>
                            <li>No network/socket</li>
                        </ul>
                    </div>
                    <div>
                        <strong style="color: #ff6666;"> External Process (10ms+)</strong>
                        <ul style="margin-top: 10px; font-size: 0.9em;">
                            <li>IPC/Socket communication</li>
                            <li>Data serialization</li>
                            <li>Context switching</li>
                            <li>Process spawn overhead</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="animateFlow()"> Animate Data Flow</button>
                <button onclick="showMemoryLayout()"> Show Memory Layout</button>
                <button onclick="compareLatencies()">Compare Latencies</button>
            </div>
        </div>
    </div>
    
    <script>
        function animateFlow() {
            const boxes = document.querySelectorAll('.process-box');
            boxes.forEach((box, index) => {
                setTimeout(() => {
                    box.style.background = 'rgba(0, 255, 0, 0.2)';
                    box.style.borderColor = '#00ff00';
                    box.style.transform = 'scale(1.02)';
                    setTimeout(() => {
                        box.style.background = '';
                        box.style.borderColor = '';
                        box.style.transform = '';
                    }, 500);
                }, index * 200);
            });
        }
        
        function showMemoryLayout() {
            alert(`Memory Layout in Vertica Process:
            
📍 0x7FFF0000 - Vertica Main Process
   ├── Column Store Buffers
   ├── Query Execution Engine
   └── UDx Function Table
   
📍 0x7FFF1000 - Shared Memory Segment
   ├── Trade Data Buffer (64KB)
   ├── Result Buffer (32KB)
   └── Lock-free Queue
   
📍 0x7FFF2000 - Loaded .so Libraries
   ├── microstructure.so
   ├── CUDA Runtime
   └── SIMD Functions
   
All in SAME virtual address space!
No page faults, no TLB misses.`);
        }
        
        function compareLatencies() {
            alert(`Latency Comparison:
            
 UDx In-Process: 100-150ns
   • Function pointer jump: 10ns
   • Memory access: 20ns
   • Computation: 70-120ns
   
 External Process: 10,000ns+
   • Process spawn: 1000ns
   • IPC setup: 500ns
   • Serialization: 2000ns
   • Network/Socket: 5000ns
   • Deserialization: 1500ns
   
 Speed Gain: 100x faster!`);
        }
        
        // Auto-animate on load
        setTimeout(animateFlow, 1000);
    </script>
</body>
</html>
